{% extends "base.html" %}
{% load content %}

{% block title %}Новое сообщение - {{ block.super }}{% endblock %}

{% block head %}
    <script type="text/javascript" src="{% MEDIA_URL %}js/jquery.datepick.js"></script>
    <script type="text/javascript" src="{% MEDIA_URL %}js/jquery.datepick-ru.js"></script>
    <script type="text/javascript" src="{% MEDIA_URL %}js/swfupload.js"></script>
    <script type="text/javascript" src="{% MEDIA_URL %}js/jquery.swfupload.js"></script>
    <script type="text/javascript" src="{% MEDIA_URL %}js/json2.min.js"></script>
    <script type="text/javascript" src="{% MEDIA_URL %}js/md5.js"></script>
    <link rel="stylesheet" href="{% MEDIA_URL %}design/3/css/contrib/datepicker/jquery.datepick.css"/>
    
    <script type="text/javascript" src="{% MEDIA_URL %}js/jquery.fcbkcomplete.min.js"></script>
    <link rel="stylesheet" href="{% MEDIA_URL %}design/3/css/contrib/fcbkstyle.css"/>

<script type="text/javascript">    
   $(function(){
     $("#id_tags").fcbkcomplete({
        json_url:'/ajax/tags_suggest',
        first_selected:false,
        filter_hide : true,
        filter_case:false,
        complete_text:"Введите теги поста",
        maxitems: 100
        });
   }); 
   
$(function(){
    $('#swfupload-control').swfupload({
        upload_url: "http://{% DOMAIN %}/ajax/add_photo?sessionid={{ request.COOKIES.sessionid }}&post={{ post.id }}",
        file_size_limit : "10240",
        file_types : "*.*",
        file_types_description : "All Files",
        file_upload_limit : "0",
        flash_url : "{% MEDIA_URL %}swf/swfupload.swf",
        button_image_url : '{% MEDIA_URL %}design/3/img/b-post-new/upload_button.png',
        button_width : 138,
        button_height : 22,
        button_placeholder : $('#button')[0],
        debug: false,
        custom_settings : {something : "here"}
    })
        .bind('fileQueued', function(event, file){
            $('#log').append('<li id="file_'+hex_md5(file.name)+'">'+file.name+'</li>');
            // start the upload since it's queued
            $(this).swfupload('startUpload');
        })
        .bind('uploadStart', function(event, file){
        	$('#file_'+hex_md5(file.name)).html(file.name + '&nbsp;<img src="{% MEDIA_URL %}design/3/img/b-ajax/ajax-loader.gif">');
        })
        .bind('uploadSuccess', function(event, file, serverData){
            myData = JSON.parse(serverData);
            $('#file_'+hex_md5(file.name)).remove();
            $('#id_content').val( $('#id_content').val() + ' <glader pic="' + myData.picture_id + '">');
            $('#thumbnails').append(            
                        '<div id="picture_' + myData.picture_id + '" class="b-picture {picture:\'' + myData.picture_id + '\'}">' +
                        '    <a href="' + myData.absolute_url + '" target="_blank"><img src="' + myData.thumbnail_url + '"></a>' +
                        '    <div class="content-btn">' +
                        '        <img src="{% MEDIA_URL %}design/3/img/b-post-new/pic_normal.png" title="Вставить эту картинку в пост"' +
                        '            class="js-post-picture-prepare {picture:\'' + myData.picture_id + '\', method:\'normal\'}" alt=""/>' +
                        '        <img src="{% MEDIA_URL %}design/3/img/b-post-new/pic_left.png" title="Вставить эту картинку с выравниванием влево"' +
                        '            class="js-post-picture-prepare {picture:\'' + myData.picture_id + '\', method:\'float_left\'}" alt=""/>' +
                        '        <img src="{% MEDIA_URL %}design/3/img/b-post-new/pic_right.png" title="Вставить эту картинку с выравниванием влево"' +
                        '            class="js-post-picture-prepare {picture:\'' + myData.picture_id + '\', method:\'float_right\'}" alt=""/>' +
                        '    </div>' +
                        '</div>'
            );
            initPostPictures();
        })
        .bind('uploadComplete', function(event, file){
            // upload has completed, lets try the next one in the queue
            $(this).swfupload('startUpload');
        })
        .bind('uploadError', function(event, file, errorCode, message){
            $('#log').append('<li>Upload error - '+message+'</li>');
        });
        
        initPostButtons();
        initPostPictures();
}); 

</script>    

<script type="text/javascript" src="/admind/jsi18n/"></script>
<script type="text/javascript" src="/admind/media/js/core.js"></script>
<script type="text/javascript" src="/admind/media/js/admin/RelatedObjectLookups.js"></script>
<script type="text/javascript" src="/admind/media/js/jquery.min.js"></script>
<script type="text/javascript" src="/admind/media/js/jquery.init.js"></script>

<script type="text/javascript" src="/admind/media/js/actions.min.js"></script>

<script type="text/javascript" src="/admind/media/js/calendar.js"></script>
<script type="text/javascript" src="/admind/media/js/admin/DateTimeShortcuts.js"></script>

<link rel="stylesheet" type="text/css" href="/admind/media/css/forms.css" />
<link rel="stylesheet" type="text/css" media="screen" href="/media/admin_tools/css/theming.css" />

{% endblock %}

{% block top_menu %}
    {% top_menu 'new' %}
{% endblock %}

{% block full_page %}
    <table class="l-page"><tr>
        <td class="l-page-g"><i></i></td>
        <td>
            {% if post and post.preview %}
                {{ post.content|parser }}<br><br>
            {% endif %}     
        
            {% ifequal post.status "save" %}
               <h1>Черновик. <a href="{{ post.get_absolute_url }}">Перейти к посту</a>.</h1>
                
            {% else %}{% ifequal post.status "del" %}
               <h1>Сообщение в корзине</h1>
            
            {% else %}
               <h1>Пост опубликован. <a href="{{ post.get_absolute_url }}">Перейти к посту</a>.</h1>
                
            {% endifequal %}{% endifequal %}
        
            <form method="post" id="editform" enctype="multipart/form-data">
            <table class="b-new-post"><tr>
                <td valign="top" class="b-form-main">
                    {%if form.str_errors%}
                        <div style="border: 1px solid red; padding: 3px;">{{form.str_errors}}</div>
                    {%endif%}  
        
                    <div>Название сообщения <br />
                        {{ form.title }}
                        <br />
                        {% if form.errors.title %}
                            <div class="red">{% for e in form.errors.title %}{{e}} {% endfor %}</div>
                        {%endif%}
                        <br />
                    </div>
            
                    <div>
                        <div class="content-btn">Текст сообщения
                            <img id="btn-strong" src="{% MEDIA_URL %}design/3/img/b-post-new/bt_strong.png" title="Сделать выделенный шрифт жирным" alt="">
                            <img id="btn-em" src="{% MEDIA_URL %}design/3/img/b-post-new/bt_em.png" title="Сделать выделенный текст курсивом" alt="">
                            <img id="btn-ins" src="{% MEDIA_URL %}design/3/img/b-post-new/bt_ins.png" title="Сделать выделенный текст подчеркнутым" alt="">
                            <img id="btn-h1" src="{% MEDIA_URL %}design/3/img/b-post-new/bt_h1.png" title="Добавить заголовок" alt="">
                            <img id="btn-h2" src="{% MEDIA_URL %}design/3/img/b-post-new/bt_h2.png" title="Добавить заголовок второго уровня" alt="">
                            <img id="btn-link" src="{% MEDIA_URL %}design/3/img/b-post-new/bt_link.png" title="Вставить ссылку" alt="">
                            <img id="btn-img" src="{% MEDIA_URL %}design/3/img/b-post-new/bt_img.png" title="Вставить картинку" alt="">
                            <img id="btn-youtube" src="{% MEDIA_URL %}design/3/img/b-post-new/bt_youtube.png" title="Вставить видеоролик" alt="">
                            <img id="btn-cut" src="{% MEDIA_URL %}design/3/img/b-post-new/bt_cut.png" title="Вставить разрыв страницы (для длинных текстов)" alt="">
                        </div>
                        
                        {{ form.content }}        
            
                        <br /><br />
            
                        <div>Теги <span style="color:#9faab7">(добавьте пару слов о посте, например: москва, burton, fs360)</span><br />
                             {{ form.tags }}
                        <br /><br />
                        </div>
                    </div>
                    
                    <table style="width: 100%">
                        <tr>
                            <td>
                                <a href="#" onclick="$('#js-event-block').show(); $(this).hide(); return false;">Указать дату события</a>
                                <div id="js-event-block" class="g-hidden">Если пост относится к какой-то дате, укажите ее<br />
                                  Дата: {{ form.event_date_start }}
                                </div>                                
                            </td>
                            <td>
			                    <a href="#" onclick="$('#js-deferred-block').show(); $(this).hide(); return false;">Выбрать дату публикации</a>
			                    <div id="js-deferred-block" class="g-hidden">Отложенная публикация<br />
			                      Дата: {{ form.deferred_date }} <br />
			                      Время: {{ form.deferred_time }}
			                    </div>
			              
			                    <input name="picdel" id="picdel" value="" type="hidden">
                            </td>
                        </tr>
                    </table>
                    <br /><br />
                    
                    {% ifequal post.status "save" %}
	                    <input name="action" value="Сохранить" type="submit" style="margin-right: 200px">
	                    <input name="action" value="Опубликовать" type="submit" style="margin-right: 200px">
	                    <input name="action" value="Удалить" type="submit">
	                    
	                {% else %}{% ifequal post.status "del" %}
	                    <input name="action" value="Восстановить" type="submit">
	                
	                {% else %}
	                    <input name="action" value="Сохранить" type="submit" style="margin-right: 200px">
	                    <input name="action" value="В черновики" type="submit" style="margin-right: 200px">
	                    <input name="action" value="Удалить" type="submit">
	                    
	                {% endifequal %}{% endifequal %}

                    {{form.post}}
                    
                </td><td valign="top">                    

                    <div id="swfupload-control">
                        <input type="button" id="button" />
                        <ol id="log"></ol>
                    </div>
                    
                    <noscript>
                        <div>Приложить картинку (при желании)<br/ >
                            {{ form.picture }}
                        </div>
                        <input name="action" value="Залить" type="submit">
                    </noscript>                                        

                    <br /><br />
                    
                    <div id="thumbnails">
                    {% for pic in pictures %}
                        <div id="picture_{{pic.id}}" class="g-line b-picture {picture:'{{pic.display_id}}'}">
                            <a href="{{pic.get_absolute_url}}" class="float_left" target="_blank"><img src="{% MEDIA_URL %}{{pic.get_thumbnail_url}}"></a>
                            <div class="content-btn">
                                <img src="{% MEDIA_URL %}design/3/img/b-post-new/pic_normal.png" title="Вставить эту картинку в пост"
                                    class="js-post-picture-prepare {picture:'{{pic.id}}', method:'normal'}" alt=""/>
                                <img src="{% MEDIA_URL %}design/3/img/b-post-new/pic_left.png" title="Вставить эту картинку с выравниванием влево"
                                    class="js-post-picture-prepare {picture:'{{pic.id}}', method:'float_left'}" alt=""/>
                                <img src="{% MEDIA_URL %}design/3/img/b-post-new/pic_right.png" title="Вставить эту картинку с выравниванием влево"
                                    class="js-post-picture-prepare {picture:'{{pic.id}}', method:'float_right'}" alt=""/>
                            </div>
                        </div>
                    {% endfor %}
                    </div>
                </td>
            </tr></table>
            </form>
        </td>
        <td class="l-page-g"><i></i></td>
    </tr></table>
{% endblock %}

{% block sape %}{% endblock %}